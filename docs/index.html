<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zelle - Send Money Instantly</title>
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5c2d91">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Zelle">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- Fallback for when Font Awesome fails to load -->
    <script>
        // Check if Font Awesome loaded, if not add fallback styles
        document.addEventListener('DOMContentLoaded', function() {
            const testIcon = document.createElement('i');
            testIcon.className = 'fas fa-home';
            testIcon.style.position = 'absolute';
            testIcon.style.left = '-9999px';
            document.body.appendChild(testIcon);
            
            const styles = window.getComputedStyle(testIcon);
            if (styles.fontFamily.indexOf('Font Awesome') === -1) {
                // Font Awesome failed to load, add fallback styles
                const fallbackCSS = `
                    .fas::before, .far::before { font-family: inherit !important; }
                    .fa-money-bill-transfer::before { content: 'üí≥'; }
                    .fa-paper-plane::before { content: 'üì§'; }
                    .fa-hand-holding-dollar::before { content: 'üí∞'; }
                    .fa-users::before { content: 'üë•'; }
                    .fa-eye::before { content: 'üëÅ'; }
                    .fa-check-circle::before { content: '‚úÖ'; }
                    .fa-arrow-left::before { content: '‚Üê'; }
                    .fa-info-circle::before { content: '‚Ñπ'; }
                `;
                const style = document.createElement('style');
                style.textContent = fallbackCSS;
                document.head.appendChild(style);
            }
            document.body.removeChild(testIcon);
        });
    </script>
    <style>
        :root {
            --primary-color: #5c2d91;
            --secondary-color: #6c39a3;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        * {margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
        body {background-color:#f5f7fb; color:var(--dark-color); line-height:1.6;}
        .container {max-width:1200px; margin:0 auto; padding:0 20px;}
        header {background:white; box-shadow:0 2px 8px rgba(0,0,0,0.1); position:sticky; top:0; z-index:100;}
        .header-content {display:flex; justify-content:space-between; align-items:center; padding:15px 0;}
        .logo {display:flex; align-items:center; font-size:24px; font-weight:700; color:var(--primary-color);}
        .logo i {margin-right:10px;}
        nav ul {display:flex; list-style:none;}
        nav ul li {margin-left:25px;}
        nav ul li a {text-decoration:none; color:var(--dark-color); font-weight:500; transition:color .3s;}
        nav ul li a:hover {color:var(--primary-color);}
        .auth-buttons {display:flex; gap:15px;}
        .btn {padding:10px 20px; border-radius:var(--border-radius); border:none; font-weight:600; cursor:pointer; transition:var(--transition);}
        .btn-primary {background:var(--primary-color); color:white;}
        .btn-primary:hover {background:var(--secondary-color);}
        .btn-outline {background:transparent; border:2px solid var(--primary-color); color:var(--primary-color);}
        .btn-outline:hover {background:var(--primary-color); color:white;}
        .btn-success {background:var(--success-color); color:white;}
        .btn-success:hover {background:#218838;}
        .app-section {display:none; padding:40px 0; min-height:500px;}
        .app-section.active {display:block;}
        .dashboard {background:white; border-radius:var(--border-radius); padding:30px; box-shadow:var(--box-shadow); margin-bottom:30px;}
        .balance {font-size:2.5rem; font-weight:700; color:var(--primary-color); margin-bottom:20px;}
        .quick-actions {display:flex; gap:15px; margin-bottom:30px; flex-wrap:wrap;}
        .transactions-list {margin-top:20px;}
        .transaction {display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #eee;}
        .transaction:last-child {border-bottom:none;}
        .transaction-details {flex:1;}
        .transaction-amount {font-weight:600;}
        .transaction.sent .transaction-amount {color:var(--danger-color);}
        .transaction.received .transaction-amount {color:var(--success-color);}
        .form-container {max-width:500px; margin:0 auto; background:white; padding:30px; border-radius:var(--border-radius); box-shadow:var(--box-shadow);}
        .form-title {text-align:center; margin-bottom:30px; color:var(--primary-color);}
        .form-group {margin-bottom:20px;}
        .form-group label {display:block; margin-bottom:8px; font-weight:500;}
        .form-control {width:100%; padding:12px 15px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:16px; transition:var(--transition);}
        .form-control:focus {border-color:var(--primary-color); outline:none; box-shadow:0 0 0 3px rgba(92,45,145,0.1);}
        .form-text {font-size:14px; color:#6c757d; margin-top:5px;}
        .alert {padding:12px 15px; border-radius:var(--border-radius); margin-bottom:20px;}
        .alert-success {background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
        .alert-danger {background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
        .alert-info {background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb;}
        .verification-inputs {display:flex; gap:10px; margin-bottom:20px; justify-content:center;}
        .verification-input {width:50px; height:60px; text-align:center; font-size:24px; border:2px solid #ddd; border-radius:var(--border-radius);}
        .verification-input:focus {border-color:var(--primary-color); outline:none;}
        .features-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:30px; margin-top:40px;}
        .feature-card {background:white; padding:30px; border-radius:var(--border-radius); text-align:center; box-shadow:var(--box-shadow); transition:var(--transition);}
        .feature-card:hover {transform:translateY(-5px);}
        .feature-icon {font-size:40px; color:var(--primary-color); margin-bottom:20px;}
        .feature-card h3 {margin-bottom:15px; color:var(--primary-color);}
        footer {background:var(--dark-color); color:white; padding:40px 0; margin-top:60px;}
        .footer-content {display:flex; justify-content:space-between; flex-wrap:wrap;}
        .footer-section {flex:1; min-width:250px; margin-bottom:30px;}
        .footer-section h3 {margin-bottom:20px; color:#e0e0e0;}
        .footer-section ul {list-style:none;}
        .footer-section ul li {margin-bottom:10px;}
        .footer-section ul li a {color:#aaa; text-decoration:none; transition:color .3s;}
        .footer-section ul li a:hover {color:white;}
        .copyright {text-align:center; padding-top:20px; margin-top:20px; border-top:1px solid #444; color:#aaa;}
        @media (max-width:768px) {
            .header-content {flex-direction:column; text-align:center;}
            nav ul {margin-top:15px; justify-content:center; flex-wrap:wrap;}
            nav ul li {margin:5px 10px;}
            .auth-buttons {margin-top:15px; justify-content:center;}
            .quick-actions {flex-direction:column;}
            .verification-inputs {justify-content:center;}
        }
        .qr-container {text-align:center; margin:20px 0;}
        .qr-code {width:200px; height:200px; background:#f1f1f1; margin:0 auto; display:flex; align-items:center; justify-content:center; border-radius:10px;}
        .tabs {display:flex; margin-bottom:20px; border-bottom:1px solid #ddd;}
        .tab {padding:10px 20px; cursor:pointer; border-bottom:3px solid transparent; transition:var(--transition);}
        .tab.active {border-bottom:3px solid var(--primary-color); font-weight:600;}
        .tab-content {display:none;}
        .tab-content.active {display:block;}
        .contact-list {max-height:200px; overflow-y:auto; border:1px solid #ddd; border-radius:var(--border-radius); margin-bottom:20px;}
        .contact-item {padding:10px 15px; border-bottom:1px solid #eee; cursor:pointer; display:flex; align-items:center; transition:var(--transition);}
        .contact-item:last-child {border-bottom:none;}
        .contact-item:hover {background:#f8f9fa;}
        .contact-icon {margin-right:10px; color:var(--primary-color);}
        .confirm-screen {background:#f8f9fa; padding:20px; border-radius:var(--border-radius); margin-bottom:20px;}
        .confirm-row {display:flex; justify-content:space-between; margin-bottom:10px;}
        .confirm-label {font-weight:500;}
        .spinner {border:4px solid rgba(0,0,0,0.1); border-left:4px solid var(--primary-color); border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto;}
        @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-money-bill-transfer"></i>
                    <span>Zelle</span>
                </div>
                <nav id="main-nav">
                    <ul>
                        <li><a href="#" class="nav-link" data-section="home">Home</a></li>
                        <li><a href="#" class="nav-link" data-section="dashboard">Dashboard</a></li>
                        <li><a href="#" class="nav-link" data-section="send">Send Money</a></li>
                        <li><a href="#" class="nav-link" data-section="request">Request Money</a></li>
                        <li><a href="#" class="nav-link" data-section="split">Split Bill</a></li>
                    </ul>
                </nav>
                <div class="auth-buttons" id="auth-buttons">
                    <button class="btn btn-outline" id="login-btn">Log In</button>
                    <button class="btn btn-primary" id="signup-btn">Sign Up</button>
                </div>
                <div id="user-menu" style="display:none;">
                    <button class="btn btn-outline" id="logout-btn">Log Out</button>
                </div>
            </div>
        </div>
    </header>
    <!-- Home Section -->
    <section class="app-section active" id="home">
        <div class="container">
            <div class="dashboard">
                <div class="balance">$1,234.56</div>
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="showSection('send')">
                        <i class="fas fa-paper-plane"></i> Send Money
                    </button>
                    <button class="btn btn-outline" onclick="showSection('request')">
                        <i class="fas fa-hand-holding-dollar"></i> Request Money
                    </button>
                    <button class="btn btn-success" onclick="showSection('split')">
                        <i class="fas fa-users"></i> Split Bill
                    </button>
                </div>
                <div class="transactions-list">
                    <h3>Recent Transactions</h3>
                    <div class="transaction sent">
                        <div class="transaction-details">
                            <div><strong>John Smith</strong></div>
                            <div style="color: #6c757d; font-size: 14px;">Dinner split</div>
                        </div>
                        <div class="transaction-amount">-$25.00</div>
                    </div>
                    <div class="transaction received">
                        <div class="transaction-details">
                            <div><strong>Sarah Johnson</strong></div>
                            <div style="color: #6c757d; font-size: 14px;">Movie tickets</div>
                        </div>
                        <div class="transaction-amount">+$15.00</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Send Money Section -->
    <section class="app-section" id="send">
        <div class="container">
            <div class="form-container">
                <h2 class="form-title">
                    <i class="fas fa-paper-plane"></i> Send Money
                </h2>
                <form id="sendForm">
                    <div class="form-group">
                        <label for="recipientEmail">Recipient Email or Phone</label>
                        <input type="text" class="form-control" id="recipientEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="sendAmount">Amount</label>
                        <input type="number" class="form-control" id="sendAmount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="sendNote">Note (Optional)</label>
                        <input type="text" class="form-control" id="sendNote" placeholder="What's this for?">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-eye"></i> Preview & Send
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- Confirmation Screen -->
    <section class="app-section" id="confirm">
        <div class="container">
            <div class="form-container">
                <h2 class="form-title">
                    <i class="fas fa-check-circle"></i> Confirm Payment
                </h2>
                <div class="confirm-screen" id="confirmationDetails">
                    <div class="confirm-row">
                        <span class="confirm-label">To:</span>
                        <span id="confirmRecipient"></span>
                    </div>
                    <div class="confirm-row">
                        <span class="confirm-label">Amount:</span>
                        <span id="confirmAmount"></span>
                    </div>
                    <div class="confirm-row">
                        <span class="confirm-label">Note:</span>
                        <span id="confirmNote"></span>
                    </div>
                </div>
                <button id="confirmSendBtn" class="btn btn-success" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-paper-plane"></i> Send Money
                </button>
                <button onclick="showSection('send')" class="btn btn-outline" style="width: 100%;">
                    <i class="fas fa-arrow-left"></i> Back to Edit
                </button>
            </div>
        </div>
    </section>

    <!-- Request Money Section -->
    <section class="app-section" id="request">
        <div class="container">
            <div class="form-container">
                <h2 class="form-title">
                    <i class="fas fa-hand-holding-dollar"></i> Request Money
                </h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Send a money request to someone via email or text.
                </div>
                <form id="requestForm">
                    <div class="form-group">
                        <label for="requestEmail">From (Email or Phone)</label>
                        <input type="text" class="form-control" id="requestEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="requestAmount">Amount</label>
                        <input type="number" class="form-control" id="requestAmount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="requestNote">What's this for?</label>
                        <input type="text" class="form-control" id="requestNote" placeholder="e.g., Split dinner bill">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-paper-plane"></i> Send Request
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- Split Bill Section -->
    <section class="app-section" id="split">
        <div class="container">
            <div class="form-container">
                <h2 class="form-title">
                    <i class="fas fa-users"></i> Split Bill
                </h2>
                <form id="splitForm">
                    <div class="form-group">
                        <label for="totalAmount">Total Bill Amount</label>
                        <input type="number" class="form-control" id="totalAmount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="splitPeople">Number of People</label>
                        <input type="number" class="form-control" id="splitPeople" min="2" value="2" required>
                    </div>
                    <div class="form-group">
                        <label>Amount per person: <span id="splitResult">$0.00</span></label>
                    </div>
                    <div class="form-group">
                        <label for="splitNote">What's this for?</label>
                        <input type="text" class="form-control" id="splitNote" placeholder="e.g., Dinner at restaurant">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-users"></i> Send Split Requests
                    </button>
                </form>
            </div>
        </div>
    </section>

    <script>
        // API Configuration - configurable for different environments
        const API_CONFIG = {
            baseURL: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:3001' 
                : `${window.location.protocol}//${window.location.hostname}`,
            apiPath: '/api'
        };
        
        const API_BASE = `${API_CONFIG.baseURL}${API_CONFIG.apiPath}`;

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    console.log('‚úÖ Service Worker registered successfully:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New content is available, refresh to use it
                                if (confirm('New version available! Refresh to update?')) {
                                    window.location.reload();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('‚ùå Service Worker registration failed:', error);
                }
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            const installButton = document.createElement('button');
            installButton.className = 'btn btn-primary install-prompt';
            installButton.innerHTML = '<i class="fas fa-download"></i> Install App';
            installButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; border-radius: 50px; padding: 12px 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);';
            
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`PWA install outcome: ${outcome}`);
                    deferredPrompt = null;
                    document.body.removeChild(installButton);
                }
            });
            
            document.body.appendChild(installButton);
            
            // Remove prompt after 10 seconds if not clicked
            setTimeout(() => {
                if (installButton.parentNode) {
                    document.body.removeChild(installButton);
                }
            }, 10000);
        }

        // Global error handling for better UX
        window.addEventListener('error', (e) => {
            console.error('Application error:', e.error);
            showAlert('An unexpected error occurred. Please try again.', 'danger');
        });

        // Network status monitoring
        window.addEventListener('online', () => {
            showAlert('You are back online!', 'success');
        });

        window.addEventListener('offline', () => {
            showAlert('You are offline. Some features may not work.', 'warning');
        });

        // Show/hide sections
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`)?.classList.add('active');
        }

        // Navigation handling
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.getAttribute('data-section');
                showSection(section);
            });
        });

        // Authentication state management
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');

        // Utility functions
        function showAlert(message, type = 'info', duration = 5000) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 300px;';
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    document.body.removeChild(alert);
                }
            }, duration);
        }

        function setLoadingState(button, loading = true) {
            if (loading) {
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = '<div class="spinner"></div> Loading...';
                button.disabled = true;
            } else {
                button.innerHTML = button.dataset.originalText || button.innerHTML;
                button.disabled = false;
            }
        }

        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 403 && data.code === 'EMAIL_NOT_VERIFIED') {
                        showAlert('Please verify your email before sending money', 'warning');
                        showSection('verify');
                        return;
                    }
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                if (error.message.includes('fetch')) {
                    showAlert('Network error. Please check your connection.', 'danger');
                } else {
                    showAlert(error.message, 'danger');
                }
                throw error;
            }
        }

        // Send form handling with API integration
        document.getElementById('sendForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const recipient = document.getElementById('recipientEmail').value;
            const amount = document.getElementById('sendAmount').value;
            const note = document.getElementById('sendNote').value || '';
            
            // Validate inputs
            if (!recipient || !amount || parseFloat(amount) <= 0) {
                showAlert('Please fill in all required fields with valid values', 'danger');
                return;
            }
            
            // Show confirmation details
            document.getElementById('confirmRecipient').textContent = recipient;
            document.getElementById('confirmAmount').textContent = '$' + parseFloat(amount).toFixed(2);
            document.getElementById('confirmNote').textContent = note || 'No note';
            
            // Show confirmation screen
            showSection('confirm');
        });

        // Confirm send button with API integration
        document.getElementById('confirmSendBtn').addEventListener('click', async function() {
            const recipient = document.getElementById('confirmRecipient').textContent;
            const amount = document.getElementById('confirmAmount').textContent.replace('$', '');
            const note = document.getElementById('confirmNote').textContent;
            
            setLoadingState(this, true);
            
            try {
                const result = await apiCall('/transactions/send', {
                    method: 'POST',
                    body: JSON.stringify({
                        recipientEmail: recipient,
                        amount: parseFloat(amount),
                        note: note === 'No note' ? '' : note
                    })
                });

                showAlert('Money sent successfully!', 'success');
                showSection('dashboard'); // Show dashboard with updated balance
                
                // Reset form
                document.getElementById('sendForm').reset();
                
                // Update balance if available
                if (result.newBalance !== undefined) {
                    updateUserBalance(result.newBalance);
                }
                
            } catch (error) {
                console.error('Send money error:', error);
            } finally {
                setLoadingState(this, false);
            }
        });

        // Request form handling with API integration
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const requesteeEmail = document.getElementById('requesteeEmail').value;
            const amount = document.getElementById('requestAmount').value;
            const note = document.getElementById('requestNote').value || '';
            
            if (!requesteeEmail || !amount || parseFloat(amount) <= 0) {
                showAlert('Please fill in all required fields with valid values', 'danger');
                return;
            }

            const submitBtn = this.querySelector('button[type="submit"]');
            setLoadingState(submitBtn, true);
            
            try {
                await apiCall('/transactions/request', {
                    method: 'POST',
                    body: JSON.stringify({
                        requesteeEmail,
                        amount: parseFloat(amount),
                        note
                    })
                });

                showAlert('Money request sent successfully!', 'success');
                this.reset();
                
            } catch (error) {
                console.error('Request money error:', error);
            } finally {
                setLoadingState(submitBtn, false);
            }
        });

        // Authentication functions
        async function register(name, email, phone, password) {
            try {
                const result = await apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, phone, password })
                });
                
                showAlert('Registration successful! Please check your email for verification.', 'success');
                showSection('verify');
                return result;
            } catch (error) {
                throw error;
            }
        }

        async function login(email, password) {
            try {
                const result = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                authToken = result.token;
                localStorage.setItem('authToken', authToken);
                currentUser = result.user;
                
                showAlert('Login successful!', 'success');
                showSection('dashboard');
                updateUserInterface();
                return result;
            } catch (error) {
                throw error;
            }
        }

        async function verifyEmail(email, code) {
            try {
                const result = await apiCall('/auth/verify-email', {
                    method: 'POST',
                    body: JSON.stringify({ email, code })
                });
                
                authToken = result.token;
                localStorage.setItem('authToken', authToken);
                currentUser = result.user;
                
                showAlert('Email verified successfully!', 'success');
                showSection('dashboard');
                updateUserInterface();
                return result;
            } catch (error) {
                throw error;
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            showSection('home');
            updateUserInterface();
            showAlert('Logged out successfully', 'info');
        }

        function updateUserInterface() {
            const isLoggedIn = !!currentUser;
            
            // Toggle auth buttons
            document.getElementById('login-btn').style.display = isLoggedIn ? 'none' : 'inline-block';
            document.getElementById('register-btn').style.display = isLoggedIn ? 'none' : 'inline-block';
            document.getElementById('logout-btn').style.display = isLoggedIn ? 'inline-block' : 'none';
            
            // Update navigation
            const dashboardNav = document.querySelector('[data-section="dashboard"]');
            if (dashboardNav) {
                dashboardNav.style.display = isLoggedIn ? 'inline-block' : 'none';
            }
            
            // Update user info if available
            if (currentUser) {
                updateUserBalance(currentUser.balance);
                // Update any user name displays
                document.querySelectorAll('.user-name').forEach(el => {
                    el.textContent = currentUser.name;
                });
            }
        }

        function updateUserBalance(balance) {
            const balanceElements = document.querySelectorAll('.user-balance');
            balanceElements.forEach(el => {
                el.textContent = '$' + balance.toFixed(2);
            });
        }

        // Load user profile if token exists
        async function loadUserProfile() {
            if (!authToken) return;
            
            try {
                const result = await apiCall('/auth/profile');
                currentUser = result.user;
                updateUserInterface();
            } catch (error) {
                console.error('Failed to load user profile:', error);
                logout(); // Clear invalid token
            }
        }

        // Split bill calculation
        function updateSplitCalculation() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const people = parseInt(document.getElementById('splitPeople').value) || 2;
            const perPerson = total / people;
            document.getElementById('splitResult').textContent = '$' + perPerson.toFixed(2);
        }

        document.getElementById('totalAmount').addEventListener('input', updateSplitCalculation);
        document.getElementById('splitPeople').addEventListener('input', updateSplitCalculation);

        // Split form handling
        document.getElementById('splitForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Split bill requests sent successfully!');
            this.reset();
            document.getElementById('splitResult').textContent = '$0.00';
        });

        // Auth button handling with proper integration
        document.getElementById('login-btn').addEventListener('click', function() {
            showSection('login');
        });

        document.getElementById('register-btn').addEventListener('click', function() {
            showSection('register');
        });

        document.getElementById('logout-btn').addEventListener('click', function() {
            logout();
        });

        // Form submissions for auth
        if (document.getElementById('loginForm')) {
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                const submitBtn = this.querySelector('button[type="submit"]');
                setLoadingState(submitBtn, true);
                
                try {
                    await login(email, password);
                } catch (error) {
                    // Error already handled in login function
                } finally {
                    setLoadingState(submitBtn, false);
                }
            });
        }

        if (document.getElementById('registerForm')) {
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const phone = document.getElementById('registerPhone').value;
                const password = document.getElementById('registerPassword').value;
                
                const submitBtn = this.querySelector('button[type="submit"]');
                setLoadingState(submitBtn, true);
                
                try {
                    await register(name, email, phone, password);
                } catch (error) {
                    // Error already handled in register function
                } finally {
                    setLoadingState(submitBtn, false);
                }
            });
        }

        if (document.getElementById('verifyForm')) {
            document.getElementById('verifyForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('verifyEmail').value;
                const code = document.getElementById('verifyCode').value;
                
                const submitBtn = this.querySelector('button[type="submit"]');
                setLoadingState(submitBtn, true);
                
                try {
                    await verifyEmail(email, code);
                } catch (error) {
                    // Error already handled in verifyEmail function
                } finally {
                    setLoadingState(submitBtn, false);
                }
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInterface();
            if (authToken) {
                loadUserProfile();
            }
            
            // Auto-focus verification code input
            const verifyCodeInputs = document.querySelectorAll('.verification-input');
            if (verifyCodeInputs.length > 0) {
                verifyCodeInputs[0].focus();
                
                // Auto-advance verification code inputs
                verifyCodeInputs.forEach((input, index) => {
                    input.addEventListener('input', function() {
                        if (this.value.length === 1 && index < verifyCodeInputs.length - 1) {
                            verifyCodeInputs[index + 1].focus();
                        }
                    });
                    
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && this.value === '' && index > 0) {
                            verifyCodeInputs[index - 1].focus();
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
